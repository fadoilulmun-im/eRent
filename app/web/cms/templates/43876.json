{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  try {\n    const data = await req.file({\n      limits: {\n        fileSize: 2000000, // 2MB\n      },\n    });\n\n    const file = data.filename.split(\".\");\n    const filename = file.slice(0, -1).join(\".\");\n    // const mimeType = data.mimetype;\n    const extension = file[file.length - 1];\n\n    const valid_extension = [\"png\", \"img\", \"svg\", \"jpg\", \"jpeg\"];\n    if (!valid_extension.includes(extension)) {\n      return reply.status(400).send({\n        status: \"ERROR\",\n        message: \"File yang dimasukkan harus gambar\",\n      });\n    }\n\n    const path = !!data.fields.path ? data.fields.path.value : \"/\";\n\n    const name =\n      (!!data.fields.name ? data.fields.name.value : filename) +\n      Date.now() +\n      \".\" +\n      extension;\n\n    const dir = ext.path.join(\n      __dirname,\n      \"..\",\n      \"..\",\n      \"..\",\n      \"uploads\",\n      \"barang\",\n      \"gambar_barang\",\n      path\n    );\n\n    const fullpath = dir + name;\n\n    if (!ext.fs.existsSync(dir)) {\n      ext.fs.mkdirSync(dir, { recursive: true });\n    }\n\n    await ext.pump(data.file, ext.fs.createWriteStream(fullpath));\n    const filePath = await ext.path\n      .join(\"/upload/barang/gambar_barang\", path, name)\n      .replace(/\\\\/gi, \"/\");\n\n    const barang = await db.barang.update({\n      where: {\n        id: Number(params.id),\n      },\n      data: {\n        gambar_barang: filePath,\n      },\n    });\n\n    reply.send({\n      status: \"ok\",\n      path: filePath,\n    });\n  } catch (e) {\n    reply.status(400).send({\n      status: \"failed\",\n      reason: e.toString(),\n    });\n  }\n}","figma":{}},"title":"upload-foto-barang","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"14213","slug":"/api/barang/[id]/upload-foto","site":"*","id":"43876"}