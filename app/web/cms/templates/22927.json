{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  if (user.user.role == \"guest\") {\n    return reply.status(401).send({\n      status: \"ERROR\",\n      message: \"Silahkan login terlebih dahulu\",\n    });\n  }\n  if (user.user.role == \"customer\") {\n    return reply.status(403).send({\n      status: \"ERROR\",\n      message: \"Hanya admin yang bisa mengakses ini\",\n    });\n  }\n\n  const id_track_template = Number(req.body.id_track_template);\n  const id_transaksi = Number(params.id);\n\n  const cek = await db.track_order.findFirst({\n    where: {\n      AND: {\n        id_transaksi: id_transaksi,\n        id_track_template: id_track_template,\n      },\n    },\n    include: {\n      track_template: true,\n    },\n  });\n\n  if (cek) {\n    return reply.status(409).send({\n      status: \"ERROR\",\n      message: \"Pesanan ini sudah pernah disini\",\n      data: cek,\n    });\n  }\n\n  const status = await db.track_template.findUnique({\n    where: {\n      id: id_track_template,\n    },\n    select: {\n      id_status: true,\n    },\n  });\n\n  const create = await db.transaksi.update({\n    where: {\n      id: id_transaksi,\n    },\n    data: {\n      status_transaksi: status.id_status,\n      track_order: {\n        create: {\n          id_track_template: id_track_template,\n        },\n      },\n    },\n  });\n\n  if (create) {\n    const id_track_order = await db.transaksi.findUnique({\n      where: {\n        id: id_transaksi,\n      },\n      select: {\n        track_order: {\n          where: {\n            id_track_template: id_track_template,\n          },\n          select: {\n            id: true,\n          },\n        },\n      },\n    });\n\n    const track = await db.track_order.findFirst({\n      where: {\n        id: id_track_order.track_order[0].id,\n      },\n      select: {\n        id: true,\n        created_at: true,\n        id_transaksi: true,\n        track_template: {\n          select: {\n            id: true,\n            title: true,\n            desc: true,\n            status: {\n              select: {\n                id: true,\n                nama: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    return reply.status(201).send({\n      status: \"SUCCESS\",\n      message: \"Berhasil melakukan update tracking\",\n      data: track,\n    });\n  }\n}","figma":{}},"title":"update-tracking","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"14213","slug":"/api/transaksi/[id]/update-tracking","site":"*","id":"22927"}