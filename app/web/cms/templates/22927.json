{"content":{"type":"API","structure":"","server_on_load":"async ({\n  template,\n  params,\n  render,\n  db,\n  req,\n  reply,\n  user,\n  log,\n  ext,\n  isDev,\n}: Server) => {\n  if (user.user.role == \"guest\") {\n    return reply.status(401).send({\n      status: \"ERROR\",\n      message: \"Silahkan login terlebih dahulu\",\n    });\n  }\n  if (user.user.role == \"customer\") {\n    return reply.status(403).send({\n      status: \"ERROR\",\n      message: \"Hanya admin yang bisa mengakses ini\",\n    });\n  }\n\n  const id_track_template = Number(req.body.id_track_template);\n  const id_transaksi = Number(params.id);\n\n  const cek = await db.track_order.findFirst({\n    where: {\n      AND: {\n        id_transaksi: id_transaksi,\n        id_track_template: id_track_template,\n      },\n    },\n    include: {\n      track_template: true,\n    },\n  });\n\n  if (cek) {\n    return reply.status(409).send({\n      status: \"ERROR\",\n      message: \"Pesanan ini sudah pernah disini\",\n      data: cek,\n    });\n  }\n\n  // mengambil id status untuk transaksi yang ada di tabel track template\n  const status = await db.track_template.findUnique({\n    where: {\n      id: id_track_template,\n    },\n    select: {\n      id_status: true,\n    },\n  });\n\n  // update status transaksi & create track order\n  const create = await db.transaksi.update({\n    where: {\n      id: id_transaksi,\n    },\n    data: {\n      status_transaksi: status.id_status,\n      track_order: {\n        create: {\n          id_track_template: id_track_template,\n          created_at: new Date(ext.nowLocal()),\n        },\n      },\n    },\n  });\n\n  if (create) {\n    const id_track_order = await db.transaksi.findUnique({\n      where: {\n        id: id_transaksi,\n      },\n      select: {\n        track_order: {\n          where: {\n            id_track_template: id_track_template,\n          },\n          select: {\n            id: true,\n          },\n        },\n      },\n    });\n\n    // mengambil data track order yang baru saja dibuat\n    const track = await db.track_order.findFirst({\n      where: {\n        id: id_track_order.track_order[0].id,\n      },\n      select: {\n        id: true,\n        created_at: true,\n        id_transaksi: true,\n        track_template: {\n          select: {\n            id: true,\n            title: true,\n            desc: true,\n            status: {\n              select: {\n                id: true,\n                nama: true,\n              },\n            },\n          },\n        },\n      },\n    });\n\n    if (track) {\n      const notif = await db.notif.create({\n        data: {\n          title: \"Order \" + track.track_template.status.nama,\n          desc: track.track_template.desc,\n          id_customer: create.id_customer,\n          created_at: new Date(ext.nowLocal()),\n        },\n      });\n\n      if (notif) {\n        ext.socket.emit(\"admin\", {\n          event: \"notif\",\n          user_id: notif.id_customer,\n          data: {\n            message: notif.title,\n            desc: notif.desc,\n            created_at: notif.created_at,\n          },\n        });\n\n        if (id_track_template === 9) {\n          await db.transaksi.update({\n            where: {\n              id: id_transaksi,\n            },\n            data: {\n              tanggal_approve: new Date(ext.nowLocal()),\n              id_admin: user.user.admin.id,\n            },\n          });\n\n          ext.socket.emit(\"admin\", {\n            event: \"notif\",\n            user_id: create.id_customer,\n            time: create.tanggal_pengembalian,\n            data: {\n              message: \"Time to return the order\",\n              desc: \"Please wait for our team to take your order\",\n            },\n          });\n        }\n      } else {\n        console.log(\"notif tidak terkirim\");\n      }\n\n      return reply.status(201).send({\n        status: \"SUCCESS\",\n        message: \"Berhasil melakukan update tracking\",\n        data: track,\n      });\n    }\n  }\n}","figma":{}},"title":"update-tracking","type":"cms-template","lang":"","status":"SYSTEM","parent_id":"14213","slug":"/api/transaksi/[id]/update-tracking","site":"*","id":"22927"}