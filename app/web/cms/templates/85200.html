<>
  <effect
    meta={{
      cart: [],
      total_harga: 0,
      total_item: 0,
      is_loding: true,
    }}
    run={async () => {
      api(`/api/customer/${user.customer.id}/cart`).then((e) => {
        console.log(e);
        meta.cart = e.data;
        meta.action.total_count();
        meta.is_loding = false;
      });

      meta.action = {
        total_count: () => {
          let tt_h = 0;
          let tt_i = 0;

          meta.cart.forEach((x, i) => {
            tt_h += x.barang.harga_barang * x.quantity;
            tt_i += x.quantity;
          });
          runInAction(() => {
            meta.total_harga = tt_h;
            meta.total_item = tt_i;
          });
        },
        update_qty: (id, qty) => {
          api(`/api/customer/${user.customer.id}/update-cart/${id}`, {
            quantity: qty,
          }).then((e) => {
            console.log(e);
          });
        },
        addQty: (idx) => {
          runInAction(() => {
            meta.cart[idx].quantity += 1;
            meta.action.total_count();
            meta.action.update_qty(meta.cart[idx].id, meta.cart[idx].quantity);
          });
        },
        subQty: (idx) => {
          runInAction(() => {
            if (meta.cart[idx].quantity > 1) {
              meta.cart[idx].quantity -= 1;
              meta.action.total_count();
              meta.action.update_qty(
                meta.cart[idx].id,
                meta.cart[idx].quantity
              );
            }
          });
        },
        del: (idx) => {
          runInAction(() => {
            api(
              `/api/customer/${user.customer.id}/delete-cart/${meta.cart[idx].id}`
            ).then((e) => {
              meta.cart.splice(idx, 1);
              meta.action.total_count();
            });
          });
        },
      };
    }}
  />
  <>
    <loding state={meta.is_loding} />
    <div
      class={
        "flex-col items-start justify-start h-screen w-full bg-white " +
        (meta.is_loding ? "hidden" : "flex")
      }
    >
      {/*notif and chart button*/}
      <top-naviagation />
      <div class="flex self-stretch flex-grow flex-col items-start justify-start overflow-auto">
        <div class="flex self-stretch flex-col space-y-4 items-start justify-start px-6">
          <div class="text-3xl font-bold text-coolGray-900">Cart</div>

          {meta.cart.length > 0 ? (
            meta.cart.map((x, i) => (
              <item-cart
                title={x.barang.nama_barang}
                img={"/fimgs/232_297.x1.svg"}
                price={x.barang.harga_barang}
                qty={x.quantity}
                add={() => {
                  meta.action.addQty(i);
                }}
                sub={() => {
                  meta.action.subQty(i);
                }}
                del={() => {
                  meta.action.del(i);
                }}
              />
            ))
          ) : (
            <div
              style="padding-top: 5rem;"
              class="text-sm font-bold leading-snug text-center text-coolGray-400 w-full"
            >
              Empty
            </div>
          )}
        </div>
      </div>
      <total-price-cart
        total_item={meta.total_item}
        total_harga={meta.total_harga}
        btn_title="checkout"
        btnClick={() => {
          location.href = "/m/checkout-mobile";
        }}
      />
    </div>
  </>
</>